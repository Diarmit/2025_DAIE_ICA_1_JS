---
title: "SQL"
author: "JS"
---
SQL libraries and connections 
```{r}
if(!require("tidyverse"))
  install.packages("tidyverse")
  library(tidyverse)

if(!require("RSQLite"))
  install.packages("RSQLite")
  library(RSQLite)

if(!require("DBI"))
  install.packages("DBI")
  library(DBI)

# interactive plots
if(!require("plotly"))
  install.packages("plotly")
library(plotly)

# support for color blind users - see scale_color_colorblind() below
if(!require("ggthemes"))
  install.packages("ggthemes")
library(ggthemes)

# allows paginated tables
if(!require("DT"))
  install.packages("DT")
library(DT)

if(!require("kableExtra"))
  install.packages("kableExtra")
  library(kableExtra)

if(!require("ggplot2"))
  install.packages("ggplot2")
  library(ggplot2)

conn <- dbConnect(RSQLite::SQLite(), "virtual_production.db")
dbListTables(conn)

```
## Core Query 1: Budget by Country
Joins Productions and Clients, sums budgets and counts projects by country.

```{r}
query_core1 <- "SELECT c.Country, SUM(p.Budget) AS TotalBudget, COUNT(*) AS ProjectCount FROM Productions p JOIN Clients c ON p.ClientID = c.ClientID GROUP BY c.Country ORDER BY TotalBudget DESC;"

result_core1 <- dbGetQuery(conn, query_core1)

DT::datatable(
  result_core1,
  options = list(pageLength = 10),
  caption = "Core Query 1: Total budget and project count per country"
)

query_dev_time_assets <- "
WITH AssetCounts AS (
  SELECT
    e.ProductionID,
    COUNT(a.AssetID) AS AssetCount
  FROM Environments e
  LEFT JOIN Assets a ON a.EnvironmentID = e.EnvironmentID
  GROUP BY e.ProductionID
),
ProductionDevTime AS (
  SELECT
    p.ProductionID,
    (julianday(p.EndDate) - julianday(p.StartDate)) AS DevDays,
    COALESCE(ac.AssetCount, 0) AS AssetCount
  FROM Productions p
  LEFT JOIN AssetCounts ac ON ac.ProductionID = p.ProductionID
)
SELECT
  CASE
    WHEN AssetCount <= 10 THEN '0–10'
    WHEN AssetCount <= 50 THEN '11–50'
    WHEN AssetCount <= 100 THEN '51–100'
    ELSE '100+'
  END AS AssetBucket,
  AVG(DevDays) AS AvgDevelopmentDays,
  COUNT(*) AS ProductionCount
FROM ProductionDevTime
GROUP BY AssetBucket
ORDER BY
  CASE AssetBucket
    WHEN '0–10' THEN 1
    WHEN '11–50' THEN 2
    WHEN '51–100' THEN 3
    ELSE 4
  END;
"

result_dev_time_assets <- dbGetQuery(conn, query_dev_time_assets)

DT::datatable(result_dev_time_assets, options = list(pageLength = 10))

```
```{r}

```

## Core Query 3: Top Crew Members

Lists the top three crew members by number of successful (completed) productions.

```{r}
query_core3 <- "
SELECT 
  cm.Name,
  COUNT(*) AS SuccessfulProductions
FROM CrewMembers cm
JOIN ProductionCrew pc ON cm.CrewID = pc.CrewID
JOIN Productions p ON pc.ProductionID = p.ProductionID
WHERE p.EndDate IS NOT NULL
GROUP BY cm.CrewID, cm.Name
ORDER BY SuccessfulProductions DESC
LIMIT 3;
"

result_core3 <- dbGetQuery(conn, query_core3)

DT::datatable(
  result_core3,
  options = list(pageLength = 10),
  caption = "Core Query 3: Top 3 crew members by successful productions"
)
```

## SQL Concept 1: LIKE and OR

Find productions with titles containing "Run" or "Drift".

```{r}
# Using LIKE to search for text patterns, OR to combine conditions
query_like_or <- "
SELECT Title, Genre, Budget
FROM Productions
WHERE Title LIKE '%Run%' OR Title LIKE '%Drift%'
ORDER BY Title;
"

result_like_or <- dbGetQuery(conn, query_like_or)

DT::datatable(result_like_or, options = list(pageLength = 10))
```