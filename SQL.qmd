---
title: "SQL"
author: "JS"
---
SQL libraries and connections 
```{r}
if(!require("tidyverse"))
  install.packages("tidyverse")
  library(tidyverse)

if(!require("RSQLite"))
  install.packages("RSQLite")
  library(RSQLite)

if(!require("DBI"))
  install.packages("DBI")
  library(DBI)

# interactive plots
if(!require("plotly"))
  install.packages("plotly")
library(plotly)

# support for color blind users - see scale_color_colorblind() below
if(!require("ggthemes"))
  install.packages("ggthemes")
library(ggthemes)

# allows paginated tables
if(!require("DT"))
  install.packages("DT")
library(DT)

if(!require("kableExtra"))
  install.packages("kableExtra")
  library(kableExtra)

if(!require("ggplot2"))
  install.packages("ggplot2")
  library(ggplot2)

conn <- dbConnect(RSQLite::SQLite(), "virtual_production.db")
dbListTables(conn)

```
## Core Query 1: Budget by Country
Joins Productions and Clients, sums budgets and counts projects by country.

```{r}
query_core1 <- "SELECT c.Country, SUM(p.Budget) AS TotalBudget, COUNT(*) AS ProjectCount FROM Productions p JOIN Clients c ON p.ClientID = c.ClientID GROUP BY c.Country ORDER BY TotalBudget DESC;"

result_core1 <- dbGetQuery(conn, query_core1)

DT::datatable(
  result_core1,
  options = list(pageLength = 10),
  caption = "Core Query 1: Total budget and project count per country"
)

query_dev_time_assets <- "
WITH AssetCounts AS (
  SELECT
    e.ProductionID,
    COUNT(a.AssetID) AS AssetCount
  FROM Environments e
  LEFT JOIN Assets a ON a.EnvironmentID = e.EnvironmentID
  GROUP BY e.ProductionID
),
ProductionDevTime AS (
  SELECT
    p.ProductionID,
    (julianday(p.EndDate) - julianday(p.StartDate)) AS DevDays,
    COALESCE(ac.AssetCount, 0) AS AssetCount
  FROM Productions p
  LEFT JOIN AssetCounts ac ON ac.ProductionID = p.ProductionID
)
SELECT
  CASE
    WHEN AssetCount <= 10 THEN '0–10'
    WHEN AssetCount <= 50 THEN '11–50'
    WHEN AssetCount <= 100 THEN '51–100'
    ELSE '100+'
  END AS AssetBucket,
  AVG(DevDays) AS AvgDevelopmentDays,
  COUNT(*) AS ProductionCount
FROM ProductionDevTime
GROUP BY AssetBucket
ORDER BY
  CASE AssetBucket
    WHEN '0–10' THEN 1
    WHEN '11–50' THEN 2
    WHEN '51–100' THEN 3
    ELSE 4
  END;
"

result_dev_time_assets <- dbGetQuery(conn, query_dev_time_assets)

DT::datatable(result_dev_time_assets, options = list(pageLength = 10))

```
This following query joins Productions and Clients, then groups by country to sum budgets and count projects. The USA leads with $3M across 5 projects, followed by the UK at $2M. 
```{r}
query_core1 <- "SELECT c.Country, SUM(p.Budget) AS TotalBudget, COUNT(*) AS ProjectCount FROM Productions p JOIN Clients c ON p.ClientID = c.ClientID GROUP BY c.Country ORDER BY TotalBudget DESC;"
```

